<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temperature Sensors</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #333;
            margin-top: 0;
        }
        
        .button-group {
            margin: 20px 0;
        }
        
        .btn {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin-right: 10px;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .btn:hover {
            background-color: #45a049;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .delete-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 6px 12px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .delete-btn:hover {
            background-color: #d32f2f;
        }
        
        .status-normal {
            color: green;
        }
        
        .status-alarm {
            color: red;
            font-weight: bold;
        }
        
        #loadingMessage {
            text-align: center;
            margin-top: 20px;
            font-style: italic;
        }
        
        .no-sensors {
            text-align: center;
            margin-top: 20px;
            color: #666;
        }
        
        .rom-address {
            font-family: monospace;
            font-size: 12px;
        }
        
        .auto-update-container {
            display: flex;
            align-items: center;
            margin-top: 20px;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin-left: 10px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #2196F3;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        #updateStatus {
            margin-left: 10px;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Temperature Sensors</h1>
        
        <div class="button-group">
            <button id="discoverBtn" class="btn">Discover Sensors</button>
            <button id="resetMinMaxBtn" class="btn">Reset Min/Max Values</button>
            <button id="clearBtn" class="btn">Clear Sensors</button>
        </div>
        
        <div class="auto-update-container">
            <span>Auto-update:</span>
            <label class="switch">
                <input type="checkbox" id="autoUpdateToggle">
                <span class="slider"></span>
            </label>
            <span id="updateStatus">Off</span>
        </div>
        
        <div id="sensorTableContainer">
            <table id="sensorTable">
                <thead>
                    <tr>
                        <th>Address</th>
                        <th>Name</th>
                        <th>Type</th>
                        <th>ROM Address</th>
                        <th>Current Temp</th>
                        <th>Min Temp</th>
                        <th>Max Temp</th>
                        <th>Low Alarm</th>
                        <th>High Alarm</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="sensorTableBody">
                    <!-- Sensor rows will be added here -->
                </tbody>
            </table>
        </div>
        
        <div id="loadingMessage">Loading sensors...</div>
    </div>

    <script>
        // Global variables
        let updateInterval = null;
        const UPDATE_INTERVAL_MS = 5000; // Update every 5 seconds
        
        document.addEventListener('DOMContentLoaded', function() {
            loadSensors();
            
            // Button event listeners
            document.getElementById('discoverBtn').addEventListener('click', discoverSensors);
            document.getElementById('resetMinMaxBtn').addEventListener('click', resetMinMax);
            document.getElementById('clearBtn').addEventListener('click', clearSensors);
            
            // Auto-update toggle
            document.getElementById('autoUpdateToggle').addEventListener('change', toggleAutoUpdate);
        });
        
        function toggleAutoUpdate() {
            const toggle = document.getElementById('autoUpdateToggle');
            const statusText = document.getElementById('updateStatus');
            
            if (toggle.checked) {
                // Start auto-update
                statusText.textContent = `On (every ${UPDATE_INTERVAL_MS/1000} seconds)`;
                
                // Immediately load data once
                loadSensors();
                
                // Then set up the interval for future updates
                updateInterval = setInterval(function() {
                    loadSensors(true); // true = silent update (no loading message)
                }, UPDATE_INTERVAL_MS);
            } else {
                // Stop auto-update
                statusText.textContent = 'Off';
                if (updateInterval) {
                    clearInterval(updateInterval);
                    updateInterval = null;
                }
            }
        }
        
        function loadSensors(silent = false) {
            if (!silent) {
                document.getElementById('loadingMessage').style.display = 'block';
                document.getElementById('loadingMessage').textContent = 'Loading sensors...';
            }
            
            fetch('/api/sensors')
                .then(response => response.json())
                .then(data => {
                    displaySensors(data);
                    if (!silent) {
                        document.getElementById('loadingMessage').style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error loading sensors:', error);
                    if (!silent) {
                        document.getElementById('loadingMessage').textContent = 'Error loading sensors';
                    }
                });
        }
        
        function displaySensors(data) {
            const tableBody = document.getElementById('sensorTableBody');
            tableBody.innerHTML = '';
            
            if (!data.sensors || data.sensors.length === 0) {
                document.getElementById('sensorTableContainer').style.display = 'none';
                document.getElementById('loadingMessage').textContent = 'No sensors found';
                document.getElementById('loadingMessage').style.display = 'block';
                return;
            }
            
            document.getElementById('sensorTableContainer').style.display = 'block';
            
            data.sensors.forEach(sensor => {
                const row = document.createElement('tr');
                
                // Format ROM address if available
                let romAddressHtml = '';
                if (sensor.type === 'DS18B20' && sensor.romAddress) {
                    const romBytes = sensor.romAddress.map(byte => {
                        // Format each byte as a 2-digit hex number
                        return ('0' + byte.toString(16).toUpperCase()).slice(-2);
                    });
                    romAddressHtml = `<span class="rom-address">${romBytes.join(' ')}</span>`;
                } else {
                    romAddressHtml = 'N/A';
                }
                
                row.innerHTML = `
                    <td>${sensor.address}</td>
                    <td>${sensor.name}</td>
                    <td>${sensor.type}</td>
                    <td>${romAddressHtml}</td>
                    <td>${sensor.currentTemp.toFixed(2)}°C</td>
                    <td>${sensor.minTemp.toFixed(2)}°C</td>
                    <td>${sensor.maxTemp.toFixed(2)}°C</td>
                    <td>${sensor.lowAlarmThreshold.toFixed(2)}°C</td>
                    <td>${sensor.highAlarmThreshold.toFixed(2)}°C</td>
                    <td class="${sensor.alarmStatus ? 'status-alarm' : 'status-normal'}">${sensor.alarmStatus ? 'ALARM' : 'Normal'}</td>
                    <td>
                        <button class="delete-btn" data-address="${sensor.address}">Delete</button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const address = this.getAttribute('data-address');
                    deleteSensor(address);
                });
            });
        }
        
        function deleteSensor(address) {
            if (confirm(`Are you sure you want to delete sensor with address ${address}?`)) {
                // Create the JSON payload
                const payload = JSON.stringify({
                    address: parseInt(address)
                });
                
                fetch('/api/sensors', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: payload
                })
                .then(response => {
                    if (response.ok) {
                        loadSensors(); // Reload the table
                    } else {
                        alert('Failed to delete sensor');
                    }
                })
                .catch(error => {
                    console.error('Error deleting sensor:', error);
                    alert('Error deleting sensor');
                });
            }
        }
        
        function discoverSensors() {
            fetch('/api/discover', {
                method: 'POST'
            })
            .then(response => {
                if (response.ok) {
                    loadSensors();
                } else {
                    alert('No new sensors found');
                }
            })
            .catch(error => {
                console.error('Error discovering sensors:', error);
                alert('Error discovering sensors');
            });
        }
        
        function resetMinMax() {
            fetch('/api/reset-minmax', {
                method: 'POST'
            })
            .then(response => {
                if (response.ok) {
                    loadSensors();
                } else {
                    alert('Failed to reset min/max values');
                }
            })
            .catch(error => {
                console.error('Error resetting min/max values:', error);
                alert('Error resetting min/max values');
            });
        }
        
        function clearSensors() {
            if (confirm('Are you sure you want to clear all sensors?')) {
                // This would require a new API endpoint to clear all sensors
                // For now, just show a message
                alert('This feature is not implemented yet');
            }
        }
    </script>
</body>
</html>
