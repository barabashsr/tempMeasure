<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temperature Sensors</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #333;
            margin-top: 0;
        }
        
        .button-group {
            margin: 20px 0;
        }
        
        .btn {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin-right: 10px;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .btn:hover {
            background-color: #45a049;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .delete-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 6px 12px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .delete-btn:hover {
            background-color: #d32f2f;
        }
        
        .status-normal {
            color: green;
        }
        
        .status-alarm {
            color: red;
            font-weight: bold;
        }
        
        #loadingMessage {
            text-align: center;
            margin-top: 20px;
            font-style: italic;
        }
        
        .no-sensors {
            text-align: center;
            margin-top: 20px;
            color: #666;
        }
        
        .rom-address {
            font-family: monospace;
            font-size: 12px;
        }
        
        .auto-update-container {
            display: flex;
            align-items: center;
            margin-top: 20px;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin-left: 10px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #2196F3;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        #updateStatus {
            margin-left: 10px;
            font-size: 14px;
            color: #666;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: inline-block;
            width: 180px;
            font-weight: bold;
        }
        
        .form-actions {
            margin-top: 20px;
            text-align: right;
        }
        
        .form-actions button {
            margin-left: 10px;
            padding: 5px 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Temperature Sensors</h1>
        
        <div class="button-group">
            <button id="discoverBtn" class="btn">Discover Sensors</button>
            <button id="resetMinMaxBtn" class="btn">Reset Min/Max Values</button>
            <button id="clearBtn" class="btn">Clear Sensors</button>
        </div>
        
        <div class="auto-update-container">
            <span>Auto-update:</span>
            <label class="switch">
                <input type="checkbox" id="autoUpdateToggle">
                <span class="slider"></span>
            </label>
            <span id="updateStatus">Off</span>
        </div>
        
        <div id="sensorTableContainer">
            <table id="sensorTable">
                <thead>
                    <tr>
                        <th>Address</th>
                        <th>Name</th>
                        <th>Type</th>
                        <th>ROM Address</th>
                        <th>Current Temp</th>
                        <th>Min Temp</th>
                        <th>Max Temp</th>
                        <th>Low Alarm</th>
                        <th>High Alarm</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="sensorTableBody">
                    <!-- Sensor rows will be added here -->
                </tbody>
            </table>
        </div>
        
        <div id="loadingMessage">Loading sensors...</div>
    </div>

    <!-- Modal for sensor configuration -->
<div id="sensorConfigModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Sensor Configuration</h2>
      <form id="sensorConfigForm">
        <input type="hidden" id="originalAddress" name="originalAddress">
        
        <div class="form-group">
          <label for="sensorAddress">Address:</label>
          <input type="number" id="sensorAddress" name="address" min="0" max="59" required>
        </div>
        
        <div class="form-group">
          <label for="sensorName">Name:</label>
          <input type="text" id="sensorName" name="name" required>
        </div>
        
        <div class="form-group">
          <label for="lowAlarmThreshold">Low Alarm Threshold (°C):</label>
          <input type="number" id="lowAlarmThreshold" name="lowAlarmThreshold" step="0.1" required>
        </div>
        
        <div class="form-group">
          <label for="highAlarmThreshold">High Alarm Threshold (°C):</label>
          <input type="number" id="highAlarmThreshold" name="highAlarmThreshold" step="0.1" required>
        </div>
        
        <div class="form-group">
          <label>Sensor Type:</label>
          <span id="sensorType"></span>
        </div>
        
        <div class="form-group" id="romAddressGroup">
          <label>ROM Address:</label>
          <span id="romAddress"></span>
        </div>
        
        <div class="form-group">
          <label>Current Temperature:</label>
          <span id="currentTemp"></span> °C
        </div>
        
        <div class="form-group">
          <label>Min Temperature:</label>
          <span id="minTemp"></span> °C
        </div>
        
        <div class="form-group">
          <label>Max Temperature:</label>
          <span id="maxTemp"></span> °C
        </div>
        
        <div class="form-group">
          <label>Alarm Status:</label>
          <span id="alarmStatus"></span>
        </div>
        
        <div class="form-group">
          <label>Error Status:</label>
          <span id="errorStatus"></span>
        </div>
        
        <div class="form-actions">
          <button type="submit" class="save-btn">Save Changes</button>
          <button type="button" class="cancel-btn">Cancel</button>
        </div>
      </form>
    </div>
  </div>
  

    <script>
        // Global variables
        let updateInterval = null;
        const UPDATE_INTERVAL_MS = 5000; // Update every 5 seconds
        
        document.addEventListener('DOMContentLoaded', function() {
            loadSensors();
            
            // Button event listeners
            document.getElementById('discoverBtn').addEventListener('click', discoverSensors);
            document.getElementById('resetMinMaxBtn').addEventListener('click', resetMinMax);
            document.getElementById('clearBtn').addEventListener('click', clearSensors);
            
            // Auto-update toggle
            document.getElementById('autoUpdateToggle').addEventListener('change', toggleAutoUpdate);
        });
        
        function toggleAutoUpdate() {
            const toggle = document.getElementById('autoUpdateToggle');
            const statusText = document.getElementById('updateStatus');
            
            if (toggle.checked) {
                // Start auto-update
                statusText.textContent = `On (every ${UPDATE_INTERVAL_MS/1000} seconds)`;
                
                // Immediately load data once
                loadSensors();
                
                // Then set up the interval for future updates
                updateInterval = setInterval(function() {
                    loadSensors(true); // true = silent update (no loading message)
                }, UPDATE_INTERVAL_MS);
            } else {
                // Stop auto-update
                statusText.textContent = 'Off';
                if (updateInterval) {
                    clearInterval(updateInterval);
                    updateInterval = null;
                }
            }
        }
        
        function loadSensors(silent = false) {
            if (!silent) {
                document.getElementById('loadingMessage').style.display = 'block';
                document.getElementById('loadingMessage').textContent = 'Loading sensors...';
            }
            
            fetch('/api/sensors')
                .then(response => response.json())
                .then(data => {
                    displaySensors(data);
                    if (!silent) {
                        document.getElementById('loadingMessage').style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error loading sensors:', error);
                    if (!silent) {
                        document.getElementById('loadingMessage').textContent = 'Error loading sensors';
                    }
                });
        }

        function updateSensorTable(sensors) {
            const tableBody = document.querySelector('table tbody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            if (sensors.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="11">No sensors found</td></tr>';
                return;
            }
            
            sensors.forEach(sensor => {
                const row = document.createElement('tr');
                
                // Create ROM address string if available
                let romAddressStr = '';
                if (sensor.type === 'DS18B20' && sensor.romAddress) {
                romAddressStr = sensor.romAddress.map(byte => byte.toString(16).padStart(2, '0')).join(':');
                }
                
                // Create status text
                let statusText = '';
                if (sensor.errorStatus > 0) {
                statusText = 'Error';
                } else if (sensor.alarmStatus > 0) {
                statusText = 'Alarm';
                } else {
                statusText = 'Normal';
                }
                
                row.innerHTML = `
                <td>${sensor.address}</td>
                <td>${sensor.name}</td>
                <td>${sensor.type}</td>
                <td>${romAddressStr}</td>
                <td>${sensor.currentTemp}</td>
                <td>${sensor.minTemp}</td>
                <td>${sensor.maxTemp}</td>
                <td>${sensor.lowAlarmThreshold}</td>
                <td>${sensor.highAlarmThreshold}</td>
                <td>${statusText}</td>
                <td>
                    <button class="config-btn" data-address="${sensor.address}">Config</button>
                </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        
        function displaySensors(data) {
            const tableBody = document.getElementById('sensorTableBody');
            tableBody.innerHTML = '';
            
            if (!data.sensors || data.sensors.length === 0) {
                document.getElementById('sensorTableContainer').style.display = 'none';
                document.getElementById('loadingMessage').textContent = 'No sensors found';
                document.getElementById('loadingMessage').style.display = 'block';
                return;
            }
            
            document.getElementById('sensorTableContainer').style.display = 'block';
            
            data.sensors.forEach(sensor => {
                const row = document.createElement('tr');
                
                // Format ROM address if available
                let romAddressHtml = '';
                if (sensor.type === 'DS18B20' && sensor.romAddress) {
                    const romBytes = sensor.romAddress.map(byte => {
                        // Format each byte as a 2-digit hex number
                        return ('0' + byte.toString(16).toUpperCase()).slice(-2);
                    });
                    romAddressHtml = `<span class="rom-address">${romBytes.join(' ')}</span>`;
                } else {
                    romAddressHtml = 'N/A';
                }
                
                row.innerHTML = `
                    <td>${sensor.address}</td>
                    <td>${sensor.name}</td>
                    <td>${sensor.type}</td>
                    <td>${romAddressHtml}</td>
                    <td>${sensor.currentTemp.toFixed(2)}°C</td>
                    <td>${sensor.minTemp.toFixed(2)}°C</td>
                    <td>${sensor.maxTemp.toFixed(2)}°C</td>
                    <td>${sensor.lowAlarmThreshold.toFixed(2)}°C</td>
                    <td>${sensor.highAlarmThreshold.toFixed(2)}°C</td>
                    <td class="${sensor.alarmStatus ? 'status-alarm' : 'status-normal'}">${sensor.alarmStatus ? 'ALARM' : 'Normal'}</td>
                    <td>
                        <button class="delete-btn" data-address="${sensor.address}">Delete</button>
                        <button class="config-btn" data-address="${sensor.address}">Config</button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const address = this.getAttribute('data-address');
                    deleteSensor(address);
                });
            });
        }
        
        function deleteSensor(address) {
            if (confirm(`Are you sure you want to delete sensor with address ${address}?`)) {
                // Create the JSON payload
                const payload = JSON.stringify({
                    address: parseInt(address)
                });
                
                fetch('/api/sensors', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: payload
                })
                .then(response => {
                    if (response.ok) {
                        loadSensors(); // Reload the table
                    } else {
                        alert('Failed to delete sensor');
                    }
                })
                .catch(error => {
                    console.error('Error deleting sensor:', error);
                    alert('Error deleting sensor');
                });
            }
        }
        
        function discoverSensors() {
            fetch('/api/discover', {
                method: 'POST'
            })
            .then(response => {
                if (response.ok) {
                    loadSensors();
                } else {
                    alert('No new sensors found');
                }
            })
            .catch(error => {
                console.error('Error discovering sensors:', error);
                alert('Error discovering sensors');
            });
        }
        
        function resetMinMax() {
            fetch('/api/reset-minmax', {
                method: 'POST'
            })
            .then(response => {
                if (response.ok) {
                    loadSensors();
                } else {
                    alert('Failed to reset min/max values');
                }
            })
            .catch(error => {
                console.error('Error resetting min/max values:', error);
                alert('Error resetting min/max values');
            });
        }
        
        function clearSensors() {
            if (confirm('Are you sure you want to clear all sensors?')) {
                // This would require a new API endpoint to clear all sensors
                // For now, just show a message
                alert('This feature is not implemented yet');
            }
        }
    </script>
    <script>
        // Get modal elements
        const modal = document.getElementById("sensorConfigModal");
        const closeBtn = modal.querySelector(".close");
        const cancelBtn = modal.querySelector(".cancel-btn");
        const configForm = document.getElementById("sensorConfigForm");
        
        // Function to open modal with sensor data
        function openConfigModal(sensorData) {
          // Set form values
          document.getElementById("originalAddress").value = sensorData.address;
          document.getElementById("sensorAddress").value = sensorData.address;
          document.getElementById("sensorName").value = sensorData.name;
          document.getElementById("lowAlarmThreshold").value = sensorData.lowAlarmThreshold;
          document.getElementById("highAlarmThreshold").value = sensorData.highAlarmThreshold;
          
          // Set read-only information
          document.getElementById("sensorType").textContent = sensorData.type;
          document.getElementById("currentTemp").textContent = sensorData.currentTemp;
          document.getElementById("minTemp").textContent = sensorData.minTemp;
          document.getElementById("maxTemp").textContent = sensorData.maxTemp;
          document.getElementById("alarmStatus").textContent = getAlarmStatusText(sensorData.alarmStatus);
          document.getElementById("errorStatus").textContent = getErrorStatusText(sensorData.errorStatus);
          
          // Handle ROM address display for DS18B20 sensors
          const romAddressGroup = document.getElementById("romAddressGroup");
          if (sensorData.type === "DS18B20" && sensorData.romAddress) {
            romAddressGroup.style.display = "block";
            const romAddressHex = sensorData.romAddress.map(byte => byte.toString(16).padStart(2, '0')).join(':');
            document.getElementById("romAddress").textContent = romAddressHex;
          } else {
            romAddressGroup.style.display = "none";
          }
          
          // Show modal
          modal.style.display = "block";
        }
        
        // Function to close modal
        function closeModal() {
          modal.style.display = "none";
        }
        
        // Close modal when clicking close button or cancel
        closeBtn.addEventListener("click", closeModal);
        cancelBtn.addEventListener("click", closeModal);
        
        // Close modal when clicking outside
        window.addEventListener("click", function(event) {
          if (event.target === modal) {
            closeModal();
          }
        });
        
        // Handle form submission
        configForm.addEventListener("submit", function(event) {
          event.preventDefault();
          
          const originalAddress = document.getElementById("originalAddress").value;
          const formData = {
            originalAddress: parseInt(originalAddress),
            address: parseInt(document.getElementById("sensorAddress").value),
            name: document.getElementById("sensorName").value,
            lowAlarmThreshold: parseFloat(document.getElementById("lowAlarmThreshold").value),
            highAlarmThreshold: parseFloat(document.getElementById("highAlarmThreshold").value)
          };
          
          // Send data to API
          fetch('/api/sensor/update', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
          })
          .then(response => {
            if (!response.ok) {
              throw new Error('Failed to update sensor');
            }
            return response.json();
          })
          .then(data => {
            closeModal();
            // Refresh sensor data
            fetchSensors();
            alert('Sensor updated successfully');
          })
          .catch(error => {
            alert('Error: ' + error.message);
          });
        });
        
        // Helper function to convert alarm status code to text
        function getAlarmStatusText(status) {
          const texts = [];
          if (status & 1) texts.push("Low Temperature");
          if (status & 2) texts.push("High Temperature");
          return texts.length > 0 ? texts.join(", ") : "Normal";
        }
        
        // Helper function to convert error status code to text
        function getErrorStatusText(status) {
          const texts = [];
          if (status & 1) texts.push("Communication Error");
          if (status & 2) texts.push("Out of Range");
          if (status & 4) texts.push("Disconnected");
          return texts.length > 0 ? texts.join(", ") : "No Errors";
        }
        
        // Add click event for config buttons
        document.addEventListener('click', function(event) {
          if (event.target.classList.contains('config-btn')) {
            const sensorAddress = parseInt(event.target.dataset.address);
            
            // Find sensor data
            fetch('/api/sensors')
              .then(response => response.json())
              .then(data => {
                const sensor = data.sensors.find(s => s.address === sensorAddress);
                if (sensor) {
                  openConfigModal(sensor);
                }
              });
          }
        });
      </script>
      
</body>
</html>
