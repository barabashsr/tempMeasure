<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temperature Monitoring System - Alarm Configuration</title>
    <link rel="stylesheet" href="/common.css">
    <style>
        /* Page-specific styles */
        main.wide {
            max-width: 1600px;
        }
        
        h1 {
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #6c757d;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .controls {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            border-left: 4px solid #3f51b5;
        }
        
        .btn {
            padding: 10px 20px;
            font-weight: 500;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #3f51b5;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1976D2;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: #4CAF50;
            color: white;
        }
        
        .btn-success:hover {
            background: #45a049;
            transform: translateY(-1px);
        }
        
        .btn-warning {
            background: #FF9800;
            color: white;
        }
        
        .btn-warning:hover {
            background: #F57C00;
            transform: translateY(-1px);
        }
        
        .table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid #dee2e6;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        thead th {
            background: #f0f4ff;
            color: #3f51b5;
            padding: 0.6em 0.8em;
            text-align: center;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tbody td {
            padding: 0.6em 0.8em;
            text-align: center;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }
        
        tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        .point-name {
            font-weight: 600;
            color: #3f51b5;
        }
        
        .temp-display {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            padding: 6px 12px;
            border-radius: 4px;
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .temp-normal {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .temp-warning {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .temp-danger {
            background: #ffebee;
            color: #c62828;
        }
        
        .input-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .threshold-input {
            width: 80px;
            padding: 6px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            text-align: center;
            font-size: 13px;
        }
        
        .threshold-input:focus {
            border-color: #3f51b5;
            outline: none;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        
        .priority-select {
            width: 100px;
            padding: 6px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .priority-select:focus {
            border-color: #3f51b5;
            outline: none;
        }
        
        .priority-disabled { background: #f8f9fa; color: #6c757d; }
        .priority-low { background: #e8f5e8; color: #2e7d32; }
        .priority-medium { background: #fff3e0; color: #ef6c00; }
        .priority-high { background: #ffebee; color: #c62828; }
        .priority-critical { background: #3f1a1a; color: white; }
        
        .sensor-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .sensor-bound {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .sensor-unbound {
            background: #ffebee;
            color: #c62828;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3f51b5;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-message {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .status-success {
            background: #e8f5e8;
            color: #2e7d32;
            border-left: 4px solid #4CAF50;
        }
        
        .status-error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }
        
        .status-info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #3f51b5;
        }
        
        @media (max-width: 768px) {
            main {
                padding: 15px;
            }
            
            table {
                font-size: 12px;
            }
            
            .threshold-input {
                width: 60px;
            }
            
            .priority-select {
                width: 80px;
            }
        }
    </style>
</head>
<body>
    <header>Temperature Monitoring System</header>
    <nav>
            <a href="/dashboard.html">Dashboard</a>
            <a href="/sensors.html">Sensors</a>
            <a href="/points.html">Points</a>
            <a href="/alarms.html">Active Alarms</a>
            <a href="/alarm-config.html" class="active">Alarm Config</a>
            <a href="/alarm-history.html">Alarm History</a>
            <a href="/event-logs.html">Event Logs</a>
            <a href="/download-logs.html">Download Logs</a>
            <a href="/config">System Config</a>
    </nav>
    <main class="wide">
        <h1>Alarm Configuration</h1>
        <p class="subtitle">Configure alarm thresholds, priorities, and hysteresis for all measurement points</p>

        <div id="statusMessage" style="display: none;"></div>

        <div class="controls">
            <button class="btn btn-primary" onclick="loadConfiguration()">
                🔄 Refresh Configuration
            </button>
            <button class="btn btn-success" onclick="applyAllChanges()">
                ✅ Apply All Changes
            </button>
            <button class="btn btn-warning" onclick="resetToDefaults()">
                🔄 Reset to Defaults
            </button>
            <span style="margin-left: auto; color: #6c757d; font-size: 13px;">
                Changes are saved automatically when you click "Apply All Changes"
            </span>
        </div>

        <div class="table-container">
            <div id="loading" class="loading">
                <div class="spinner"></div>
                Loading alarm configuration...
            </div>
            
            <table id="configTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Point</th>
                        <th>Name</th>
                        <th>Current Temp</th>
                        <th>Sensor Status</th>
                        <th colspan="2">Low Alarm</th>
                        <th colspan="2">High Alarm</th>
                        <th colspan="2">Error Alarm</th>
                        <th>Hysteresis</th>
                        <th>Actions</th>
                    </tr>
                    <tr>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th>Threshold</th>
                        <th>Enable/Priority</th>
                        <th>Threshold</th>
                        <th>Enable/Priority</th>
                        <th colspan="2">Enable/Priority</th>
                        <th></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="configTableBody">
                    <!-- Dynamic content will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let configData = [];
        let hasUnsavedChanges = false;

        // Load configuration on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadConfiguration();
        });

        async function loadConfiguration() {
            try {
                showLoading(true);
                showStatus('Loading alarm configuration...', 'info');
                
                const response = await fetch('/api/alarm-config');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                configData = data.points || [];
                
                displayConfiguration();
                showStatus(`Loaded configuration for ${configData.length} measurement points`, 'success');
                
            } catch (error) {
                console.error('Error loading configuration:', error);
                showStatus('Error loading alarm configuration: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function displayConfiguration() {
            const tbody = document.getElementById('configTableBody');
            tbody.innerHTML = '';

            if (configData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 40px; color: #6c757d;">
                            No measurement points found
                        </td>
                    </tr>
                `;
                return;
            }

            configData.forEach(point => {
                const row = createConfigurationRow(point);
                tbody.appendChild(row);
            });
        }

        function createConfigurationRow(point) {
            const row = document.createElement('tr');
            
            // Determine temperature status
            const tempClass = getTempStatusClass(point.currentTemp, point.lowThreshold, point.highThreshold);
            
            row.innerHTML = `
                <td><strong>${point.address}</strong></td>
                <td class="point-name">
                    <input type="text" value="${point.name || 'Point ' + point.address}" 
                           style="border: none; background: transparent; font-weight: 600; color: #3f51b5; width: 100%;"
                           onchange="updatePointConfig(${point.address}, 'name', this.value)">
                </td>
                <td>
                    <span class="temp-display ${tempClass}">
                        ${point.currentTemp !== null ? point.currentTemp.toFixed(1) + '°C' : 'N/A'}
                    </span>
                </td>
                <td>
                    <span class="sensor-status ${point.sensorBound ? 'sensor-bound' : 'sensor-unbound'}">
                        ${point.sensorBound ? '✅ Bound' : '❌ Unbound'}
                    </span>
                </td>
                <td>
                    <input type="number" class="threshold-input" 
                           value="${point.lowThreshold || 0}" step="0.1"
                           onchange="updatePointConfig(${point.address}, 'lowThreshold', parseFloat(this.value))">
                </td>
                <td>
                    <input type="checkbox" ${point.lowEnabled ? 'checked' : ''} 
                           onchange="updatePointConfig(${point.address}, 'lowEnabled', this.checked)"
                           style="margin-right: 5px;">
                    <select class="priority-select priority-${getPriorityClass(point.lowPriority)}"
                            onchange="updatePointConfig(${point.address}, 'lowPriority', parseInt(this.value)); this.className = 'priority-select priority-' + getPriorityClass(parseInt(this.value))">
                        ${generatePriorityOptions(point.lowPriority)}
                    </select>
                </td>
                <td>
                    <input type="number" class="threshold-input" 
                           value="${point.highThreshold || 50}" step="0.1"
                           onchange="updatePointConfig(${point.address}, 'highThreshold', parseFloat(this.value))">
                </td>
                <td>
                    <input type="checkbox" ${point.highEnabled ? 'checked' : ''} 
                           onchange="updatePointConfig(${point.address}, 'highEnabled', this.checked)"
                           style="margin-right: 5px;">
                    <select class="priority-select priority-${getPriorityClass(point.highPriority)}"
                            onchange="updatePointConfig(${point.address}, 'highPriority', parseInt(this.value)); this.className = 'priority-select priority-' + getPriorityClass(parseInt(this.value))">
                        ${generatePriorityOptions(point.highPriority)}
                    </select>
                </td>
                <td colspan="2">
                    <input type="checkbox" ${point.errorEnabled ? 'checked' : ''} 
                           onchange="updatePointConfig(${point.address}, 'errorEnabled', this.checked)"
                           style="margin-right: 5px;">
                    <select class="priority-select priority-${getPriorityClass(point.errorPriority)}"
                            onchange="updatePointConfig(${point.address}, 'errorPriority', parseInt(this.value)); this.className = 'priority-select priority-' + getPriorityClass(parseInt(this.value))">
                        ${generatePriorityOptions(point.errorPriority)}
                    </select>
                </td>
                <td>
                    <input type="number" class="threshold-input" 
                           value="${point.hysteresis || 2}" step="0.1" min="0"
                           onchange="updatePointConfig(${point.address}, 'hysteresis', parseFloat(this.value))">
                </td>
                <td>
                    <button class="btn btn-warning" style="font-size: 11px; padding: 4px 8px;" 
                            onclick="resetPointToDefaults(${point.address})">
                        Reset
                    </button>
                </td>
            `;
            
            return row;
        }

        function generatePriorityOptions(selectedValue) {
            const priorities = [
                { value: 0, label: 'Low' },
                { value: 1, label: 'Medium' },
                { value: 2, label: 'High' },
                { value: 3, label: 'Critical' }
            ];
            
            return priorities.map(p => 
                `<option value="${p.value}" ${p.value === selectedValue ? 'selected' : ''}>${p.label}</option>`
            ).join('');
        }

        function getPriorityClass(priority) {
            const classes = ['low', 'medium', 'high', 'critical'];
            return classes[priority] || 'low';
        }

        function getTempStatusClass(temp, low, high) {
            if (temp === null) return '';
            if (temp < low || temp > high) return 'temp-danger';
            if (temp < low + 5 || temp > high - 5) return 'temp-warning';
            return 'temp-normal';
        }

        function updatePointConfig(address, field, value) {
            const point = configData.find(p => p.address === address);
            if (point) {
                point[field] = value;
                hasUnsavedChanges = true;
                
                // Update temperature status if threshold changed
                if (field === 'lowThreshold' || field === 'highThreshold') {
                    const row = event.target.closest('tr');
                    const tempDisplay = row.querySelector('.temp-display');
                    if (tempDisplay && point.currentTemp !== null) {
                        tempDisplay.className = 'temp-display ' + getTempStatusClass(point.currentTemp, point.lowThreshold, point.highThreshold);
                    }
                }
            }
        }

        async function applyAllChanges() {
            if (!hasUnsavedChanges) {
                showStatus('No changes to apply', 'info');
                return;
            }

            try {
                showStatus('Applying configuration changes...', 'info');
                
                const response = await fetch('/api/alarm-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        changes: configData.map(point => ({
                            address: point.address,
                            name: point.name,
                            lowThreshold: point.lowThreshold,
                            highThreshold: point.highThreshold,
                            lowPriority: point.lowPriority,
                            highPriority: point.highPriority,
                            errorPriority: point.errorPriority,
                            lowEnabled: point.lowEnabled,
                            highEnabled: point.highEnabled,
                            errorEnabled: point.errorEnabled,
                            hysteresis: point.hysteresis
                        }))
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                showStatus('Configuration applied successfully!', 'success');
                hasUnsavedChanges = false;
                
                // Reload to get fresh data
                setTimeout(loadConfiguration, 1000);
                
            } catch (error) {
                console.error('Error applying configuration:', error);
                showStatus('Error applying configuration: ' + error.message, 'error');
            }
        }

        function resetPointToDefaults(address) {
            const point = configData.find(p => p.address === address);
            if (point) {
                point.lowThreshold = 0;
                point.highThreshold = 80;
                point.lowPriority = 2; // Medium
                point.highPriority = 2; // Medium
                point.errorPriority = 3; // High
                point.lowEnabled = false;
                point.highEnabled = false;
                point.errorEnabled = point.sensorBound; // Auto-enable if sensor bound
                point.hysteresis = 5;
                
                hasUnsavedChanges = true;
                displayConfiguration();
                showStatus(`Reset Point ${address} to default values`, 'info');
            }
        }

        function resetToDefaults() {
            if (confirm('Are you sure you want to reset ALL points to default alarm settings?')) {
                configData.forEach(point => {
                    point.lowThreshold = 0;
                    point.highThreshold = 80;
                    point.lowPriority = 2; // Medium
                    point.highPriority = 2; // Medium
                    point.errorPriority = 3; // High
                    point.lowEnabled = false;
                    point.highEnabled = false;
                    point.errorEnabled = point.sensorBound; // Auto-enable if sensor bound
                    point.hysteresis = 5;
                });
                
                hasUnsavedChanges = true;
                displayConfiguration();
                showStatus('All points reset to default values. Click "Apply All Changes" to save.', 'info');
            }
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('configTable').style.display = show ? 'none' : 'table';
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.style.display = 'block';
            
            // Auto-hide after 5 seconds for success/info messages
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Warn about unsaved changes when leaving the page
        window.addEventListener('beforeunload', function(e) {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
    </main>
</body>
</html>